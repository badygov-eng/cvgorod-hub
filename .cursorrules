# =============================================================================
# Cursor Rules for cvgorod-hub
# =============================================================================

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
- **–ù–∞–∑–≤–∞–Ω–∏–µ**: cvgorod-hub
- **ID –¥–ª—è –¥–µ–ø–ª–æ—è**: cvgorod-hub
- **–ü—É—Ç—å**: ~/cvgorod-hub
- **–ü–æ—Ä—Ç—ã**: 8300-8399
- **–¢–∏–ø**: Python (Telegram Bot + REST API + PostgreSQL)

## –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
–ü–µ—Ä–µ–¥ –ª—é–±—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ—á–∏—Ç–∞–π:
- /Users/danielbadygov/MCP/GLOBAL_RULES.md
- /Users/danielbadygov/MCP/INFRASTRUCTURE_REGISTRY.md
- /Users/danielbadygov/MCP/DEVELOPMENT_WORKFLOW.md
- /Users/danielbadygov/MCP/CLOUDFLARE_RULES.md ‚Äî **–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –†–§!**

## ‚òÅÔ∏è Cloudflare (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –†–§!)
> **Cloudflare Proxy –∏ Tunnel –ë–õ–û–ö–ò–†–£–Æ–¢–°–Ø –≤ –†–æ—Å—Å–∏–∏!**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ |
|----------|-----------|-------------|
| DNS | A ‚Üí 158.160.153.14 | CNAME ‚Üí tunnel |
| Proxy | **OFF** (—Å–µ—Ä–æ–µ –æ–±–ª–∞–∫–æ) | ON (–æ—Ä–∞–Ω–∂–µ–≤–æ–µ) |
| SSL | Let's Encrypt + nginx | Cloudflare SSL |

üìñ –ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: `docs/CLOUDFLARE_RULES.md`

## Shared –º–æ–¥—É–ª–∏ MCP (–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨!)
```python
# LLM –∫–ª–∏–µ–Ω—Ç—ã (DeepSeek)
from MCP.shared.llm import DeepSeekClient

# GigaChat
from MCP.shared.gigachat import GigaChatClient

# –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
from MCP.shared.secrets_loader import load_project_secrets
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
cvgorod-hub/
‚îú‚îÄ‚îÄ api/              # FastAPI endpoints
‚îú‚îÄ‚îÄ bot/              # Telegram bot (collector)
‚îú‚îÄ‚îÄ services/         # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ config/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ scripts/          # –°–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏
```

## –î–µ–ø–ª–æ–π
```bash
mcp deploy --project cvgorod-hub
```

### –°–µ—Ä–≤–µ—Ä
- **IP**: 158.160.153.14
- **–ü—É—Ç—å**: /home/badygovdaniil/cvgorod-hub
- **–°–µ—Ä–≤–∏—Å**: cvgorod-hub
- **–ü–æ—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**: 8300

### –î–æ–º–µ–Ω
- `cvgorod.testbotgigachat.org` ‚Äî Hub API (A ‚Üí IP, Proxy OFF)

## –°–µ–∫—Ä–µ—Ç—ã
–°–µ–∫—Ä–µ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ `~/.secrets/`:
- `~/.secrets/cvgorod/hub_api.env` ‚Äî Hub API key
- `~/.secrets/telegram/cvgorod.env` ‚Äî Telegram —Ç–æ–∫–µ–Ω
- `~/.secrets/cloud/deepseek.env` ‚Äî DeepSeek API

## –ü–æ—Ä—Ç—ã
| –°—Ä–µ–¥–∞ | –°—É—Ñ—Ñ–∏–∫—Å | –ü—Ä–∏–º–µ—Ä |
|-------|---------|--------|
| Production | XX00 | 8300 |
| Development | XX80 | 8380 |

## –ó–∞–ø—Ä–µ—â–µ–Ω–æ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—ã –≤–Ω–µ 8300-8399
- –•–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏
- –ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—ã –Ω–∞ 0.0.0.0

## Code Quality Rules
1. HTTP Timeout ‚Äî –í–°–ï–ì–î–ê (30.0 —Å–µ–∫)
2. Error Handling –≤ FastAPI ‚Äî —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
3. Pydantic Strict Mode
4. Type Hints ‚Äî –í–°–ï–ì–î–ê

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê (–ø–æ—Å–ª–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ 14.01.2026)

### –ë—ç–∫–∞–ø –ü–ï–†–ï–î –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ë–î
```bash
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏, –¥–µ–ø–ª–æ–µ–º, –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ö–µ–º—ã:
./scripts/backup_db.sh
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ü–û–°–õ–ï –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
docker exec cvgorod-hub-postgres psql -U cvgorod -d cvgorod_hub -c "
SELECT 'chats', COUNT(*) FROM chats
UNION ALL SELECT 'users', COUNT(*) FROM users  
UNION ALL SELECT 'messages', COUNT(*) FROM messages;
"
# –û–∂–∏–¥–∞–µ–º—ã–π –º–∏–Ω–∏–º—É–º: >200 —á–∞—Ç–æ–≤, >200 users, >40000 messages
```

### –ó–ê–ü–†–ï–©–ï–ù–û –±–µ–∑ –±—ç–∫–∞–ø–∞
- `docker volume rm cvgorod-hub_postgres_data`
- `docker-compose down -v`

### –ê–≤—Ç–æ–±—ç–∫–∞–ø
- –ù–∞—Å—Ç—Ä–æ–µ–Ω cron: `0 3 * * *` ‚Üí `/home/badygovdaniil/cvgorod-hub/scripts/auto_backup.sh`
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ: `ls -la backups/`

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
| Volume | –ë–∞–∑–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|------|----------|
| cvgorod-hub_postgres_data | cvgorod_hub | –¢–µ–∫—É—â–∞—è –ë–î |
| cvgorod_postgres_data | cvgorod_messages | –°—Ç–∞—Ä–∞—è –ë–î (–±—ç–∫–∞–ø) |

–°–º. –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: `DATA_MIGRATION_RULES.md`

## –Ø–∑—ã–∫
–û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

---

## üóÑÔ∏è –ö–†–ò–¢–ò–ß–ù–û: –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

> **–ò–ù–¶–ò–î–ï–ù–¢ 14.01.2026:** –ü–æ—Ç–µ—Ä—è–Ω–æ 40,000+ –∑–∞–ø–∏—Å–µ–π –∏–∑-–∑–∞ –ø—É—Ç–∞–Ω–∏—Ü—ã —Å Docker volumes.
> üìñ –ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: `~/MCP/docs/DATABASE_OPERATIONS.md`

### –ë—ç–∫–∞–ø –ü–ï–†–ï–î –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ë–î
```bash
./scripts/backup_db.sh
```

### –ó–ê–ü–†–ï–©–ï–ù–û –±–µ–∑ –±—ç–∫–∞–ø–∞
- `docker-compose down -v` ‚Äî —É–¥–∞–ª—è–µ—Ç –í–°–ï volumes!
- `docker volume rm` / `docker volume prune`
- `TRUNCATE`, `DROP TABLE`

### –ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –ß–ï–ö–õ–ò–°–¢
1. –ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ò–°–¢–û–ß–ù–ò–ö–ï
2. –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø: `./scripts/backup_db.sh`
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
5. –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –°–¢–û–ü!


---

## üß™ –ü–†–ê–í–ò–õ–ê –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

> üìñ –ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: `~/MCP/docs/TESTING_RULES.md`

### Database Connection ‚Äî –ù–ò–ö–û–ì–î–ê –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å!

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
conn = await asyncpg.connect(host='localhost', port=5432)

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
from tests.conftest import get_db_config
conn = await asyncpg.connect(**get_db_config())
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π get_db_config()

```python
def get_db_config() -> dict:
    return {
        'host': os.getenv('DB_HOST', 'localhost'),
        'port': int(os.getenv('DB_PORT', '5434')),  # External!
        'user': os.getenv('DB_USER', 'postgres'),
        'password': os.getenv('DB_PASSWORD', 'postgres'),
        'database': os.getenv('DB_NAME', 'app'),
    }
```

### –ü–æ—Ä—Ç—ã –ë–î –≤ Docker

| –ö–æ–Ω—Ç–µ–∫—Å—Ç | –•–æ—Å—Ç | –ü–æ—Ä—Ç |
|----------|------|------|
| –õ–æ–∫–∞–ª—å–Ω–æ (—Ç–µ—Å—Ç—ã) | `localhost` | `5434` |
| –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ | `postgres` | `5432` |

### asyncpg Exceptions

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (v0.28+):
asyncpg.InvalidCatalogNameError

# ‚ùå –£–°–¢–ê–†–ï–õ–û:
asyncpg.InvalidCatalogError
```

### Graceful DB Absence

```python
if response.status_code == 500:
    pytest.skip("Database not available")
```

### Docker Platform (Mac ‚Üí Server)

```bash
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
docker build -t myapp .

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
docker build --platform linux/amd64 -t myapp .
```

üìñ Docker –ø—Ä–∞–≤–∏–ª–∞: `~/MCP/docs/DOCKER_RULES.md`



---

## üîê –°–ï–ö–†–ï–¢–´ –ò CREDENTIALS (–ö–†–ò–¢–ò–ß–ù–û!)

> **–ò–ù–¶–ò–î–ï–ù–¢ 14.01.2026:** –•–∞—Ä–¥–∫–æ–¥ –ø–∞—Ä–æ–ª—è –≤ docker-compose.yml
> üìñ –ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: `~/MCP/docs/SECRETS_RULES.md`

### –ù–ò–ö–û–ì–î–ê –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å –≤ docker-compose.yml!

```yaml
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û:
DATABASE_URL: postgresql://user:secret_password@host/db

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
DATABASE_URL: ${DATABASE_URL:-postgresql://user:${POSTGRES_PASSWORD}@host/db}
```

### –ù–ò–ö–û–ì–î–ê –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å –≤ –∫–æ–¥–µ!

```python
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û:
api_key = "sk-1234567890"

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
api_key = os.getenv("API_KEY")
```

### –°–µ–∫—Ä–µ—Ç—ã –¢–û–õ–¨–ö–û –∏–∑ ~/.secrets/

```
~/.secrets/
‚îú‚îÄ‚îÄ cloud/          # API –∫–ª—é—á–∏ (openrouter, deepseek, fal)
‚îú‚îÄ‚îÄ telegram/       # –¢–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤
‚îî‚îÄ‚îÄ database/       # –ü–∞—Ä–æ–ª–∏ –ë–î
```

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ env vars –≤ docker-compose

| –°–µ—Ä–≤–∏—Å | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
|--------|-------------|
| –° PostgreSQL | `DATABASE_URL` |
| –° Redis | `REDIS_URL` |
| Telegram –±–æ—Ç | `TELEGRAM_BOT_TOKEN` |

### SQL JOIN ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π alias!

```sql
-- ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (u.role –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ JOIN):
SELECT u.role FROM users u JOIN user_roles ur ON ...

-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (ur.role_name –∏–∑ —Ç–∞–±–ª–∏—Ü—ã user_roles):
SELECT ur.role_name FROM users u JOIN user_roles ur ON ...
```

