# Анализ проблем cvgorod-hub

## 1. Почему не работает автоматический деплой

**Проблема 1: Неправильный SSH ключ**
```bash
# В deploy-prod.sh используется правильный ключ:
SSH_KEY="~/.ssh/yandex_vm_key"

# Но я пытался использовать:
# ssh -i ~/.ssh/id_ed25519 badygovd@158.160.153.14
# А ключ id_ed25519 не существует!
```

**Проблема 2: Неправильный порт в health check**
```bash
# В deploy-prod.sh:138 - проверяется порт 8000
curl -sf http://127.0.0.1:8000/health

# Но проект использует порт 8300!
```

## 2. Работает ли бэкап перед деплоем

**✅ ДА**, бэкап работает:
- Создаётся архив в `/home/badygovdaniil/.backups/cvgorod-hub/`
- Исключаются: `.git`, `venv`, `__pycache__`, `logs`, `data`, `backups`, `node_modules`
- Хранятся последние 10 бэкапов

## 3. Почему потерялся доступ к SSH

**Причина:** MCP infrastructure registry указывает ключ `~/.ssh/yandex_vm_key`, но я пытался использовать несуществующий `id_ed25519`.

**Решение:** Использовать правильный ключ:
```bash
ssh -i ~/.ssh/yandex_vm_key badygovdaniil@158.160.153.14
```

## 4. Почему не увидел проблемы с эндпоинтами раньше

**Главная проблема: Тесты НЕ покрывают функциональность!**

### Текущие тесты (test_api.py):
```python
# Только проверяют авторизацию (401)
def test_clients_requires_auth(self, client):
    response = client.get("/api/v1/clients")
    assert response.status_code == 401  # ✅ Проходит

# НЕТ тестов реальной функциональности!
# SQL запросы с INTERVAL '$1 days' НЕ тестируются
```

### conftest.py полностью мокает базу данных:
```python
mock_db.get_unanswered_questions = AsyncMock(return_value=[])  # Возвращает пустой список
# Реальный SQL запрос НИКОГДА не выполняется!
```

**Следствие:** SQL баги типа `INTERVAL '$1 days'` не ловятся тестами.

## 5. Исправления

### Исправление 1: deploy-prod.sh - порт health check
```diff
-    if curl -sf http://127.0.0.1:8000/health > /dev/null 2>&1; then
+    if curl -sf http://127.0.0.1:8300/health > /dev/null 2>&1; then
```

### Исправление 2: Добавить интеграционные тесты для SQL запросов

Нужны тесты которые:
1. Создают тестовую БД с реальными данными
2. Выполняют SQL запросы
3. Проверяют что параметры в INTERVAL работают

### Исправление 3: SSH доступ
```bash
# Использовать правильный ключ
ssh -i ~/.ssh/yandex_vm_key badygovdaniil@158.160.153.14
```

## 6. Что нужно сделать сейчас

1. **Задеплоить исправления SQL запросов** (уже сделано в коде)
2. **Запустить тесты** чтобы убедиться что ничего не сломалось
3. **Добавить интеграционные тесты** для SQL запросов
4. **Исправить deploy-prod.sh** - порт health check

## 7. Согласно правилам MCP

**Правила MCP требуют:**
- ✅ Тесты для критической функциональности
- ✅ CI/CD pipeline с автотестами
- ✅ Деплой с бэкапом
- ✅ Health checks

**Чего не хватает:**
- ❌ Интеграционных тестов для БД
- ❌ E2E тестов для API эндпоинтов
- ❌ Проверки SQL синтаксиса в CI

---
*Дата: 2026-01-14*
*Автор: Claude AI*
